<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
</head>

<body>
	<style>
		body,
		div,
		dl,
		dt,
		dd,
		ul,
		ol,
		li,
		h1,
		h2,
		h3,
		h4,
		h5,
		h6,
		pre,
		code,
		form,
		fieldset,
		legend,
		input,
		button,
		textarea,
		p,
		blockquote,
		th,
		td {
			margin: 0;
			padding: 0;
		}

		body {
			background: #fff;
			color: #555;
			font-size: 14px;
			font-family: Verdana, Arial, Helvetica, sans-serif;
		}

		td,
		th,
		caption {
			font-size: 14px;
		}

		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-weight: normal;
			font-size: 100%;
		}

		address,
		caption,
		cite,
		code,
		dfn,
		em,
		strong,
		th,
		var {
			font-style: normal;
			font-weight: normal;
		}

		a {
			color: #555;
			text-decoration: none;
		}

		a:hover {
			text-decoration: underline;
		}

		img {
			border: none;
		}

		ol,
		ul,
		li {
			list-style: none;
		}

		input,
		textarea,
		select,
		button {
			font: 14px Verdana, Helvetica, Arial, sans-serif;
		}

		table {
			border-collapse: collapse;
		}

		html {
			overflow-y: scroll;
		}

		.clearfix:after {
			content: ".";
			display: block;
			height: 0;
			clear: both;
			visibility: hidden;
		}

		.clearfix {
			*zoom: 1;
		}

		body {
			background: #ddd;
		}

		#nav {
			background: #ccc;
		}

		.section#vueT input {
			width: 300px;
			height: 25px;
			background: rgb(172, 26, 26);
			outline: 1px red solid;
		}

		#btn {
			display: flex;
			overflow: hidden;
			width: 300px;
			flex: initial;
			justify-content: space-evenly;
			border: greenyellow solid 1px;
		}

		#btn button {
			height: auto;
		}

		.section#vueT button {
			width: 80px;
			height: 30px;
			background: #ff6600;
			border: none;
			border-radius: 7px;
		}

		.gameBox {
			width: 100%;
			position: relative;
		}

		.box {
			display: flex;
			position: relative;
			border-radius: 10px;
			margin: 0 auto;
			width: 320px;
			height: 320px;
			flex-wrap: wrap;
			padding: 0px;
			justify-content: space-around;
			align-content: space-around;
			background: #f5a671;
			-webkit-user-select: none;
			-moz-user-select: none;
			-khtml-user-select: none;
			-ms-user-select: none;
			-o-user-select: none;
			user-select: none;
		}

		.gameBox li {
			width: 22.5%;
			height: 22.5%;
			border-radius: 6px;
			background: #ddb56b;
			position: relative;
			text-align: center;
			overflow: hidden;
		}
		.gameBox li:nth-child(4n){
			margin-right: 4px;
		}
		.gameBox li:nth-child(4n-3){
			margin-left: 4px;
		}
		.gameBox li:nth-child(1),
		.gameBox li:nth-child(2),
		.gameBox li:nth-child(3),
		.gameBox li:nth-child(4){
			margin-top: 4px;
		}
		.gameBox li:nth-child(13),
		.gameBox li:nth-child(14),
		.gameBox li:nth-child(15),
		.gameBox li:nth-child(16){
			margin-bottom: 4px;
		}
		.gameBox li div {
			position: absolute;
			font-size: 2.6em;
			line-height: 2em;
			border-radius: 6px;
			width: 100%;
			height: 100%;
		}

		.gameBox li.other {
			top: 360px;
			position: absolute;
			width: 100%;
			background: none;
		}
		.gameBox li.other span{
			cursor: pointer;
			height: 20px;
			width: 148px;
			line-height: 20px;
			font-family: "微软雅黑", Arial, Helvetica, sans-serif;
			font-size: 14px;
			font-weight: 100;
			border-radius: 6px;
		}

		.gameBox li.other .reB {
			color: #fce8da;
			border: 1px solid #fce8da;
			float: right;
			margin-right: 8px;
		}
		.gameBox li.other .reN {
			float: left;
			margin-left: 8px;
			color: #9eaefc;
			border: 1px solid #9eaefc;
		}

		.gameBox .lv0 {
			color: transparent;
		}

		.gameBox .lv2 {
			background: #d8eef1;
			z-index: 3;
		}

		.gameBox .lv4 {
			background: #bff7ed;
			z-index: 4;
		}

		.gameBox .lv8 {
			background: #83d2fe;
			z-index: 5;
		}

		.gameBox .lv16 {
			color: #fff;
			background: #52a3f3;
			z-index: 6;
		}

		.gameBox .lv32 {
			color: #fff;
			background: #4a24cc;
			z-index: 7;
		}

		.gameBox .lv64 {
			color: #fff;
			background: #92529c;
			z-index: 8;
		}

		.gameBox .lv128 {
			color: #fff;
			background: #ce2d96;
			z-index: 9;
		}

		.gameBox .lv256 {
			color: #fff;
			background: #ce2d96;
			z-index: 10;
		}

		.gameBox .lv512 {
			color: #fff;
			background: #ce2d96;
			z-index: 11;
		}

		.gameBox .lv1024 {
			color: transparent;
			background: url(./1024.jpg);
			background-size: cover;
			z-index: 12;
		}

		.gameBox .lv2048 {
			color: transparent;
			background: url(./2048.jpg);
			background-size: cover;
			z-index: 13;
		}

		.gameBox .lv4096 {
			color: transparent;
			background: url(./4096.jpg);
			background-size: cover;
			z-index: 14;
		}

		.gameBox .lv8192 {
			color: #fff;
			background: #888888;
			z-index: 15;
		}

		.gameBox .lv16384 {
			color: #fff;
			background: #000000;
			z-index: 16;
		}

		.gameBox .lv32768 {
			color: #c5c5c5;
			background: #ffffff;
			z-index: 418;
		}

		.bronAn {
			animation: bAn 500ms 150ms;
		}
		@keyframes bAn {
			0% {
				transform: scale(0.6);
			}
			100% {
				transform: scale(1);
			}
		}
		.changeAn1{
			animation: change1 300ms 100ms;
		}
		@keyframes change1{
			0% {
				transform: rotateX(270deg);
			}
			100% {
				transform: rotateX(360deg);
			}
		}
		.changeAn2{
			animation: change2 300ms 100ms;
		}
		@keyframes change2{
			0% {
				transform: rotateY(270deg);
			}
			100% {
				transform: rotateY(360deg);
			}
		}
		.changeAn3{
			animation: change3 300ms 100ms;
		}
		@keyframes change3{
			0% {
				transform: rotateY(450deg);
			}
			100% {
				transform: rotateY(360deg);
			}
		}
		.changeAn4{
			animation: change4 300ms 100ms;
		}
		@keyframes change4{
			0% {
				transform: rotateY(450deg);
			}
			100% {
				transform: rotateY(360deg);
			}
		}
		.moveC1{
			animation: moveC1 100ms;
		}
		@keyframes moveC1{
			0% {
				transform: rotateX(0deg);
			}
			100% {
				transform: rotateX(90deg);
			}
		}
		.moveC2{
			animation: moveC2 100ms;
		}
		@keyframes moveC2{
			0% {
				transform: rotateY(0deg);
			}
			100% {
				transform: rotateY(90deg);
			}
		}.moveC3{
			animation: moveC3 100ms;
		}
		@keyframes moveC3{
			0% {
				transform: rotateY(0deg);
			}
			100% {
				transform: rotateY(-90deg);
			}
		}.moveC4{
			animation: moveC4 100ms;
		}
		@keyframes moveC4{
			0% {
				transform: rotateX(0deg);
			}
			100% {
				transform: rotateX(-90deg);
			}
		}
		.move1_1{
			animation: move1_1 100ms forwards;
		}
		@keyframes move1_1{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: 78px;
			}
		}
		.move1_2{
			animation: move1_2 100ms forwards;
		}
		@keyframes move1_2{
			0% {
				left: 0px;
			}
			100% {
				left: 78px;
			}
		}.move1_3{
			animation: move1_3 100ms forwards;
		}
		@keyframes move1_3{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: -78px;
			}
		}.move1_4{
			animation: move1_4 100ms forwards;
		}
		@keyframes move1_4{
			0% {
				left: 0px;
			}
			100% {
				left: -78px;
			}
		}
		
		.move2_1{
			animation: move2_1 100ms forwards;
		}
		@keyframes move2_1{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: 156px;
			}
		}
		.move2_2{
			animation: move2_2 100ms forwards;
		}
		@keyframes move2_2{
			0% {
				left: 0px;
			}
			100% {
				left: 156px;
			}
		}.move2_3{
			animation: move2_3 100ms forwards;
		}
		@keyframes move2_3{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: -156px;
			}
		}.move2_4{
			animation: move2_4 100ms forwards;
		}
		@keyframes move2_4{
			0% {
				left: 0px;
			}
			100% {
				left: -156px;
			}
		}

		.move3_1{
			animation: move3_1 100ms forwards;
		}
		@keyframes move3_1{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: 234px;
			}
		}
		.move3_2{
			animation: move3_2 100ms forwards;
		}
		@keyframes move3_2{
			0% {
				left: 0px;
			}
			100% {
				left: 234px;
			}
		}.move3_3{
			animation: move3_3 100ms forwards;
		}
		@keyframes move3_3{
			0% {
				bottom: 0px;
			}
			100% {
				bottom: -234px;
			}
		}.move3_4{
			animation: move3_4 100ms forwards;
		}
		@keyframes move3_4{
			0% {
				left: 0px;
			}
			100% {
				left: -234px;
			}
		}
		.eg{
			background: red;
			position: relative;
			color: #83d2fe;
			font-size: 55px;
			width: 72px;
			height: 72px;
			margin: 0 auto;
		}
		.erroAn {
			position: relative;
			animation: eAn 300ms;
		}
		@keyframes eAn {
			0% {
				left: 0;
				right: 0;
			}
			10% {
				left: 20px;
				right: 0;
			}
			40% {
				right: 20px;
				left: 0;
			}
			60% {
				left: 20px;
				right: 0;
			}
			90% {
				right: 20px;
				left: 0;
			}
			100% {
				left: 0px;
				right: 0;
			}
		}
		.lose {
			animation: lose 6000ms 1000ms ease;
		}

		@keyframes lose {
			0% {
				transform: scale(1)
			}
			5% {
				transform: scale(0)
			}
			15% {
				transform: scale(1.1)
			}
			17% {
				transform: scale(1);
			}
			19% {
				transform: scale(0.9);
			}
			21% {
				transform: scale(1);
			}
			21% {
				transform: rotateY(0deg);
			}
			100% {
				transform: rotateY(10800deg);
			}
		}

		.gameTop {
			animation: gTop 1000ms forwards ease;
		}

		.gameTopC {
			animation: gTopC 1000ms forwards ease;
		}

		@keyframes gTop {
			0% {
				top: 0px
			}
			100% {
				top: -200px;
			}
		}

		@keyframes gTopC {
			100% {
				top: 0px
			}
			0% {
				top: -200px;
			}
		}

		.hAndS {
			position: relative;
		}

		.sOn {
			top: 1.2rem;
			right: 1.6rem;
			width: 2rem;
			height: 0.7rem;
			position: absolute;
			z-index: 5;
			border-radius: 1rem;
			border: 1px #666 solid;
			font-size: 0.6rem;
			font-weight: 1000;
			text-align: center;
			line-height: 0.7rem;
			cursor: pointer;
		}

		.sOnOn {
			animation: 2666ms sonon forwards;
		}

		.sOnOnC {
			animation: 2666ms sononC forwards;
		}

		@keyframes sonon {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 1;
			}
		}

		@keyframes sononC {
			100% {
				opacity: 0;
			}
			0% {
				opacity: 1;
			}
		}

		.sOff {
			animation: sOff 1000ms forwards ease;
		}

		.sOffC {
			animation: sOffC 1000ms forwards ease;
		}

		@keyframes sOff {
			0% {
				transform: scaleY(1);
				top: -0;
			}
			100% {
				transform: scaleY(0);
				top: -120px;
			}
		}

		@keyframes sOffC {
			100% {
				transform: scaleY(1);
				top: -0;
			}
			0% {
				transform: scaleY(0);
				top: -120px;
			}
		}

		.box0 {
			margin: 50px auto;
			display: -webkit-box;
			display: -ms-flexbox;
			display: flex;
			width: 140px;
			height: 140px;
			background: black;
			position: relative;
			-webkit-animation: boxX0 4s cubic-bezier(.3, 1.09, .54, .48);
			animation: boxX0 4s cubic-bezier(.3, 1.09, .54, .48);
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
		}

		@-webkit-keyframes boxX0 {
			from {
				-webkit-transform: rotate(0deg);
				transform: rotate(0deg);
			}
			to {
				-webkit-transform: rotate(180deg);
				transform: rotate(180deg);
			}
		}

		@keyframes boxX0 {
			from {
				-webkit-transform: rotate(0deg);
				transform: rotate(0deg);
			}
			to {
				-webkit-transform: rotate(180deg);
				transform: rotate(180deg);
			}
		}

		.inner0 {
			width: 82px;
			height: 114px;
			background: white;
			position: relative;
			margin: auto;
			-webkit-animation: innerX0 2s ease;
			animation: innerX0 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes innerX0 {
			from {
				width: 82px;
				height: 114px;
			}
			to {
				width: 124px;
				height: 124px;
			}
		}

		@keyframes innerX0 {
			from {
				width: 82px;
				height: 114px;
			}
			to {
				width: 124px;
				height: 124px;
			}
		}

		.doteBox1 {
			width: 38px;
			height: 0px;
			left: 24px;
			background: black;
			position: absolute;
			border: black solid 0px;
			-webkit-animation: BoxX1 2s ease;
			animation: BoxX1 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX1 {
			from {}
			to {
				width: 5px;
				height: 103px;
				left: 72px;
			}
		}

		@keyframes BoxX1 {
			from {}
			to {
				width: 5px;
				height: 103px;
				left: 72px;
			}
		}

		.doteBox2 {
			background: black;
			width: 22px;
			height: 0px;
			left: 62px;
			top: 0;
			position: absolute;
			border: black solid 0px;
			-webkit-animation: BoxX2 2s ease;
			animation: BoxX2 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX2 {
			from {}
			to {
				width: 50px;
				height: 50px;
				top: 10;
				left: 76px;
			}
		}

		@keyframes BoxX2 {
			from {}
			to {
				width: 50px;
				height: 50px;
				top: 10;
				left: 76px;
			}
		}

		.doteBox3 {
			/*float: right;*/
			/*top: 0px;*/
			background: black;
			width: 30px;
			height: 0px;
			top: 0px;
			left: 32px;
			position: absolute;
			border: black solid 0px;
			-webkit-animation: BoxX3 2s ease;
			animation: BoxX3 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX3 {
			from {}
			to {
				width: 33px;
				height: 43px;
				left: 72px;
				top: 60px;
			}
		}

		@keyframes BoxX3 {
			from {}
			to {
				width: 33px;
				height: 43px;
				left: 72px;
				top: 60px;
			}
		}

		.doteBox4 {
			width: 38px;
			height: 0px;
			left: 22px;
			top: 115px;
			background: black;
			border: black solid 0px;
			position: absolute;
			-webkit-animation: BoxX4 2s ease;
			animation: BoxX4 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX4 {
			from {}
			to {
				width: 5px;
				height: 105px;
				left: 48px;
				top: 19px;
			}
		}

		@keyframes BoxX4 {
			from {}
			to {
				width: 5px;
				height: 105px;
				left: 48px;
				top: 19px;
			}
		}

		.doteBox5 {
			background: black;
			width: 22px;
			height: 0px;
			left: 0px;
			top: 115px;
			position: absolute;
			border: black solid 0px;
			-webkit-animation: BoxX5 2s ease;
			animation: BoxX5 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX5 {
			from {}
			to {
				width: 50px;
				height: 52px;
				left: 0px;
				top: 72px;
			}
		}

		@keyframes BoxX5 {
			from {}
			to {
				width: 50px;
				height: 52px;
				left: 0px;
				top: 72px;
			}
		}

		.doteBox6 {
			background: black;
			width: 30px;
			height: 0px;
			top: 115px;
			left: 24px;
			border: black solid 0px;
			position: absolute;
			-webkit-animation: BoxX6 2s ease;
			animation: BoxX6 2s ease;
			-webkit-animation-fill-mode: forwards;
			animation-fill-mode: forwards;
			-webkit-animation-iteration-count: infinite;
			animation-iteration-count: infinite;
			-webkit-animation-direction: alternate;
			animation-direction: alternate;
		}

		@-webkit-keyframes BoxX6 {
			from {}
			to {
				width: 33px;
				height: 43px;
				left: 16px;
				top: 19px;
			}
		}

		@keyframes BoxX6 {
			from {}
			to {
				width: 33px;
				height: 43px;
				left: 16px;
				top: 19px;
			}
		}

		.mx {
			display: flex;
		}

		.mx>* {
			margin: auto;
			z-index: -2;
		}

		#sakura {
			position: absolute;
			z-index: -1;
		}

		.tomatch {
			position: relative;
			width: 100%;
		}
	</style>
	<div class="tomatch">
		<canvas id="sakura"></canvas>
		<div class="mx">
			<h2>谢祎娃你个瓜婆娘</h2>
		</div>
		<span id="sOn" class="sOn" style="display: none">+</span>
		<div class="hAndS" id="hAndS">
			<div class="box0" id="sOff">
				<div class="inner0">
					<div class="doteBox1">
					</div>
					<div class="doteBox2">
					</div>
					<div class="doteBox3">
					</div>
					<div class="doteBox4">
					</div>
					<div class="doteBox5">
					</div>
					<div class="doteBox6">
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
		</div>
		<div class="eg changeAn1"><div class="eg moveC2">75</div></div>
		<div class="gameBox" id="gameBox">
			<ul class="box" id="box" v-model="values">
				<li v-for="pv,index in box" v-bind:class="[theMove[index]]">
					<div v-bind:class="[pv,'lv'+values[index],newOne[index],changed[index],toChange[index]]">
						{{values[index]}}
					</div>
				</li>
				<li class="other">
					<span id="reB" class="reB" style="display: none;">Re.Back</span>
					<span class="reN" style="display: block;">Re.New</span>
				</li>
			</ul>
			<div></div>
		</div>
	</div>
	<script src="https://cdn.bootcss.com/vue/2.5.16/vue.min.js"></script>
	<script>
		// 判断浏览器
		var browserInfo = function (userAgent) {
		var u = userAgent || navigator.userAgent;
		var self = this;
		var match = {
        //内核
        'Trident': u.indexOf('Trident') > 0 || u.indexOf('NET CLR') > 0,
        'Presto': u.indexOf('Presto') > 0,
        'WebKit': u.indexOf('AppleWebKit') > 0,
        'Gecko': u.indexOf('Gecko/') > 0,
        //浏览器
        'Safari': u.indexOf('Safari') > 0,
        'Chrome': u.indexOf('Chrome') > 0 || u.indexOf('CriOS') > 0,
        'IE': u.indexOf('MSIE') > 0 || u.indexOf('Trident') > 0,
        'Edge': u.indexOf('Edge') > 0,
        'Firefox': u.indexOf('Firefox') > 0,
        'Opera': u.indexOf('Opera') > 0 || u.indexOf('OPR') > 0,
        'Vivaldi': u.indexOf('Vivaldi') > 0,
        'UC': u.indexOf('UC') > 0 || u.indexOf(' UBrowser') > 0,
        'QQBrowser': u.indexOf('QQBrowser') > 0,
        'QQ': u.indexOf('QQ/') > 0,
        'Baidu': u.indexOf('Baidu') > 0 || u.indexOf('BIDUBrowser') > 0,
        'Maxthon': u.indexOf('Maxthon') > 0,
        'LBBROWSER': u.indexOf('LBBROWSER') > 0,
        '2345Explorer': u.indexOf('2345Explorer') > 0,
        'Sogou': u.indexOf('MetaSr') > 0 || u.indexOf('Sogou') > 0,
        'Wechat': u.indexOf('MicroMessenger') > 0,
        'Taobao': u.indexOf('AliApp(TB') > 0,
        'Alipay': u.indexOf('AliApp(AP') > 0,
        'Weibo': u.indexOf('Weibo') > 0,
        'Suning': u.indexOf('SNEBUY-APP') > 0,
        'iQiYi': u.indexOf('IqiyiApp') > 0,
        //操作系统平台
        'Windows': u.indexOf('Windows') > 0,
        'Linux': u.indexOf('Linux') > 0,
        'Mac': u.indexOf('Macintosh') > 0,
        'Android': u.indexOf('Android') > 0 || u.indexOf('Adr') > 0,
        'WP': u.indexOf('IEMobile') > 0,
        'BlackBerry': u.indexOf('BlackBerry') > 0 || u.indexOf('RIM') > 0 || u.indexOf('BB') > 0,
        'MeeGo': u.indexOf('MeeGo') > 0,
        'Symbian': u.indexOf('Symbian') > 0,
        'iOS': u.indexOf('like Mac OS X') > 0,
        //移动设备
        'Mobile': u.indexOf('Mobi') > 0 || u.indexOf('iPh') > 0 || u.indexOf('480') > 0,
        'Tablet': u.indexOf('Tablet') > 0 || u.indexOf('iPad') > 0 || u.indexOf('Nexus 7') > 0
    };
    if (match.Mobile) {
        match.Mobile = !(u.indexOf('iPad') > 0);
    }
    //基本信息
    var hash = {
        engine: ['WebKit', 'Trident', 'Gecko', 'Presto'],
        browser: ['Safari', 'Chrome', 'IE', 'Edge', 'Firefox', 'Opera', 'Vivaldi', 'UC', 'QQBrowser', 'QQ', 'Baidu', 'Maxthon', 'Sogou', 'LBBROWSER', '2345Explorer', 'Wechat', 'Taobao', 'Alipay', 'Weibo', 'Suning', 'iQiYi'],
        os: ['Windows', 'Linux', 'Mac', 'Android', 'iOS', 'WP', 'BlackBerry', 'MeeGo', 'Symbian'],
        device: ['Mobile', 'Tablet']
    };
    self.device = 'PC';
    self.language = (function () {
        var g = (navigator.browserLanguage || navigator.language);
        var arr = g.split('-');
        if (arr[1]) {
            arr[1] = arr[1].toUpperCase();
        }
        return arr.join('-');
    })();
    for (var s in hash) {
        for (var i = 0; i < hash[s].length; i++) {
            var value = hash[s][i];
            if (match[value]) {
                self[s] = value;
            }
        }
    }
    //系统版本信息
    var osVersion = {
        'Windows': function () {
            var v = u.replace(/^.*Windows NT ([\d.]+);.*$/, '$1');
            var hash = {
                '6.4': '10',
                '6.3': '8.1',
                '6.2': '8',
                '6.1': '7',
                '6.0': 'Vista',
                '5.2': 'XP',
                '5.1': 'XP',
                '5.0': '2000'
            };
            return hash[v] || v;
        },
        'Android': function () {
            return u.replace(/^.*Android ([\d.]+);.*$/, '$1');
        },
        'iOS': function () {
            return u.replace(/^.*OS ([\d_]+) like.*$/, '$1').replace(/_/g, '.');
        },
        'Mac': function () {
            return u.replace(/^.*Mac OS X ([\d_]+).*$/, '$1').replace(/_/g, '.');
        }
    }
    self.osVersion = '';
    if (osVersion[self.os]) {
        self.osVersion = osVersion[self.os]();
    }
    //浏览器版本信息
    var version = {
        'Chrome': function () {
            return u.replace(/^.*Chrome\/([\d.]+).*$/, '$1');
        },
        'IE': function () {
            var v = u.replace(/^.*MSIE ([\d.]+).*$/, '$1');
            if (v == u) {
                v = u.replace(/^.*rv:([\d.]+).*$/, '$1');
            }
            return v != u ? v : '';
        },
        'Edge': function () {
            return u.replace(/^.*Edge\/([\d.]+).*$/, '$1');
        },
        'Firefox': function () {
            return u.replace(/^.*Firefox\/([\d.]+).*$/, '$1');
        },
        'Safari': function () {
            return u.replace(/^.*Version\/([\d.]+).*$/, '$1');
        },
        'Opera': function () {
            return u.replace(/^.*Opera\/([\d.]+).*$/, '$1');
        },
        'Vivaldi': function () {
            return u.replace(/^.*Vivaldi\/([\d.]+).*$/, '$1');
        },
        'Maxthon': function () {
            return u.replace(/^.*Maxthon\/([\d.]+).*$/, '$1');
        },
        'QQBrowser': function () {
            return u.replace(/^.*QQBrowser\/([\d.]+).*$/, '$1');
        },
        'QQ': function () {
            return u.replace(/^.*QQ\/([\d.]+).*$/, '$1');
        },
        'Baidu': function () {
            return u.replace(/^.*BIDUBrowser[\s\/]([\d.]+).*$/, '$1');
        },
        'UC': function () {
            return u.replace(/^.*UC?Browser\/([\d.]+).*$/, '$1');
        },
        '2345Explorer': function () {
            return u.replace(/^.*2345Explorer\/([\d.]+).*$/, '$1');
        },
        'Wechat': function () {
            return u.replace(/^.*MicroMessenger\/([\d.]+).*$/, '$1');
        },
        'Taobao': function () {
            return u.replace(/^.*AliApp\(TB\/([\d.]+).*$/, '$1');
        },
        'Alipay': function () {
            return u.replace(/^.*AliApp\(AP\/([\d.]+).*$/, '$1');
        },
        'Weibo': function () {
            return u.replace(/^.*weibo__([\d.]+).*$/, '$1');
        },
        'Suning': function () {
            return u.replace(/^.*SNEBUY-APP([\d.]+).*$/, '$1');
        },
        'iQiYi': function () {
            return u.replace(/^.*IqiyiVersion\/([\d.]+).*$/, '$1');
        }
    };
    self.version = '';
    if (version[self.browser]) {
        self.version = version[self.browser]();
    }
};
		var browserInfo = new browserInfo();
		console.log("浏览器"+browserInfo.browser);
		console.log("版本"+browserInfo.version);
		console.log("内核"+browserInfo.engine);
		console.log("操作系统"+browserInfo.os+""+browserInfo.osVersion);
		console.log("设备"+browserInfo.device);
		console.log("语言"+browserInfo.language);

		 //添加cookie
		function setCookie(name,value,time){ 
			var date= new Date(); 
			date.setDate(date.getDate()+time);
			document.cookie = name+"="+value+";expires="+date; 
		} 
		//获得cookie
		function getCookie(name){ 
			var arr = document.cookie.split(";"); 
			for(var i=0; i<arr.length; i++){ 
			var arr2 = arr[i].split("="); 
				if(arr2[0] == name){ 
					return arr2[1]; 
				} 
			} 
			return null; 
		} 
		//删除cookie
		function removeCookie(name){ 
			setCookie(name,"",0) 
		} 
		
		// 7days 收缩
		var sSwitch = document.querySelector(".hAndS");
		var sOn = document.querySelector("#sOn");
		var game = document.querySelector("#gameBox");
		var sSwitchClass;
		var sOnClass;
		var gameClass;
		sSwitchClass = sSwitch.className;
		sOnClass = sOn.className;
		gameClass = game.className;
		sSwitch.addEventListener("touchend", fucOff, true);
		sSwitch.addEventListener("click", fucOff, true);
		sOn.addEventListener("touchend", fucOn, true);
		sOn.addEventListener("click", fucOn, true);

		function fucOff() {
			sSwitch.className = sSwitchClass + " sOff";
			sOn.setAttribute("style", 'display:black');
			sOn.className = sOnClass + " sOnOn";
			game.className = gameClass + " gameTop";
		}
		function fucOn() {
			sSwitch.className = sSwitchClass + " sOffC";
			sOn.setAttribute("style", 'display:none');
			sOn.className = sOnClass + " sOnOnC";
			game.className = gameClass + " gameTopC";
		}


		// ==========================2048
		var newOne = [];
		var values = [];
		var box = [];
		var changed =[];
		var toChange =[];
		var theMove =[];
		var vGame = new Vue({
			el: "#box",
			data: {
				box,
				values,
				newOne,
				theMove,
				changed,
				toChange
			},
			methods: {
			}
		})
		var racNXN;
		// 悔棋操作 棋谱池
		var reBackup = [];
		// 储存悔棋后 之前随机生成的方块位子 
		var backUpRe = [];
		// var backUpNum = 0;
		// PS：如果执行相同操作 
		// 将生成之前相同的方块，而不是随机生成新的
		var reBa = document.querySelector("#reB");
		var boxD = document.querySelector("#gameBox");
		var moveFlag, setx, sety;
		var org = document.querySelector("#box").className;

		// ==========全局变量声明
		racNXN = 4
		//规格;
		rac(racNXN)
		function rac(rac) {
			for (ii = 1; ii < rac + 1; ii++) {
				for (jj = 1; jj < rac + 1; jj++) {
					box.push("b" + ii + "-" + jj);
				}
			}
			values.length = rac * rac;
		}
		// 0000000000000000
		function stopDrop() {
			var lastY;//最后一次y坐标点
			$(document.body).on('touchstart', function (event) {
				lastY = event.originalEvent.changedTouches[0].clientY;//点击屏幕时记录最后一次Y度坐标。
			});
			$(document.body).on('touchmove', function (event) {
				var y = event.originalEvent.changedTouches[0].clientY;
				var st = $(this).scrollTop(); //滚动条高度  
				if (y >= lastY && st <= 10) {//如果滚动条高度小于0，可以理解为到顶了，且是下拉情况下，阻止touchmove事件。
					lastY = y;
					event.preventDefault();
				}
				lastY = y;

			});
		}
		// 0000000000000000

		boxD.addEventListener("mousedown", function (e) {
			moveFlag = true;
			setx = e.clientX;
			sety = e.clientY;
		}, false);
		boxD.addEventListener("mousemove", function (e) {
			if (moveFlag) {
				var x, y;
				x = setx - e.clientX;
				y = sety - e.clientY;

				if (Math.abs(x) > 100 || Math.abs(y) > 100) {
					if (Math.abs(x) > Math.abs(y)) {
						if (x > 0) {
							toMove(4);
						} else {
							toMove(2)
						}
					} else {
						if (y > 0) {
							toMove(1)
						} else {
							toMove(3)
						}
					}
				}
			}
		}, false);
		boxD.addEventListener("mouseup", function (e) {
			moveFlag = false;
		}, false);
		boxD.addEventListener("touchstart", function (e) {
			moveFlag = true;
			setx = e.touches[0].clientX;
			sety = e.touches[0].clientY;
		}, false);
		boxD.addEventListener("touchmove", function (e) {
			// 禁止浏览器上下拉
			e.preventDefault();
			if (moveFlag) {
				var x, y;
				x = setx - e.touches[0].clientX;
				y = sety - e.touches[0].clientY;

				if (Math.abs(x) > 30 || Math.abs(y) > 30) {
					if (Math.abs(x) > Math.abs(y)) {
						if (x > 0) {
							toMove(4);
						} else {
							toMove(2)
						}
					} else {
						if (y > 0) {
							toMove(1)
						} else {
							toMove(3)
						}
					}
				}
			}
		}, false);
		boxD.addEventListener("mouseup", function (e) {
			moveFlag = false;
		}, false);



		// 读取存档
		if(document.cookie){
			var valArr;
			valArr = getCookie('lastCookie');
			valArr = JSON.parse(valArr);
			values.length=0;
			for(ak in valArr['values']){
				values.push(valArr['values'][ak]);
			}
			reBackup = valArr['reBackup'];
			backUpRe = valArr['backUpRe'];
			if(reBackup[0]){
				reBa.setAttribute("style", "");
			}
		}else{
			init(4);
		}
		// 初始随机生成4个
		function init(Nub){
			var init4 = [];
			var ran16 = []
			if(!Nub){
				Nub = 4;
			}
			for (i = 1; i < racNXN*racNXN+1; i++) {
				ran16.push(i)
			}
			for (i = 0; i < Nub; i++) {
				init4.push(ran16.splice(parseInt(Math.random() * (16 - i)), 1)[0])
			}
			for (k in init4) {
				vGame.values.splice(init4[k] - 1, 1, (parseInt(Math.random() * 2) + 1) * 2)
			}
			for (k in ran16) {
				vGame.values.splice(ran16[k] - 1, 1, 0)
			}
		}
		// 主动重开
		document.querySelector(".reN").addEventListener("touched",reStart,false)
		document.querySelector(".reN").addEventListener("click",reStart,false)
		function reStart(){
			if(confirm("请问老板要重新开始吗 Orz")){
				values.length = 0;
				values.length = racNXN*racNXN;
				init(4);
				reBackup.length = 0;
				backUpRe.length =0;
				reB.setAttribute("style", "display:none");
				setCookie("lastCookie",cookieData(),14);
			}
		}

		// 上右下左1234 移动法则
		function toMove(goTo) {
			var forChange =[];
			forChange.length=0;
			
			theMove.length=16;
			changed.length=16;
			toChange.length=16;

			moveFlag = false;
			var newV = [];
			if (goTo == 1) {
				str = 0;
				strh = 0;
				sa = 1;
				ha = 1;
			} else if (goTo == 2) {
				str = 0;
				strh = 3;
				sa = 1;
				ha = -1;
			} else if (goTo == 3) {
				str = 3;
				strh = 0;
				sa = -1;
				ha = 1;
			} else if (goTo == 4) {
				str = 0;
				strh = 0;
				sa = 1;
				ha = 1;
			}
			if (goTo == 2 || goTo == 4) {
				for (s = str; s < 4 && s > -1;) {
					var stg = [];
					var forCheak = [];
					var plus0 =0;
					for (h = strh; h < 4 && h > -1;) {
						if (values[s * 4 + h] != 0) {
							if(forCheak[0] == values[s * 4 + h]){
								// var plusV;
								// if(!theMove[forCheak[1]]){
								// 	plusV=0;
								// }else{
								// 	plusV = theMove[forCheak[1]];
								// };
								// theMove.splice((s * 4 + h),1,(plusV+plus0));
								toChange.splice((s * 4 + h),1,'moveC'+goTo);
								forChange.push(s * 4 + h);
								forCheak[0]=0;
								plus0++;
							}else{
								forCheak[0] = values[s * 4 + h];
								forCheak[1] = s * 4 + h;
							}
							var plusV;
							if(!theMove[s * 4 + h]){
								plusV=0;
							}else{
								plusV = theMove[s * 4 + h];
							};
							theMove.splice((s * 4 + h),1,(plusV+plus0));
							stg.push(values[s * 4 + h])
						}
						else{
							plus0++;
							console.log(plus0)
						}
							
						h = h + ha
					}
					for (p = 0; stg[++p];) {
						if (stg[p - 1] == stg[p]) {
							stg[p - 1] += stg[p];
							stg.splice(p, 1)
						}
					}
					for (i = 0, p = (4 - stg.length); i < p; i++) {
						stg.push(0)
					}
					if (goTo == 2) {
						stg = stg.reverse();
					}
					newV = newV.concat(stg)
					s = s + sa;
				}
			}
			if (goTo == 1 || goTo == 3) {
				for (h = strh; h < 4 && h > -1;) {
					var stg = [];
					var forCheak = [];
					var plus0 =0;
					for (s = str; s < 4 && s > -1;) {

						// if (values[s * 4 + h] > 1) {
						// 	if(forCheak[0] == values[s * 4 + h]){
						// 		var plusV;
						// 		if(!theMove[forCheak[1]]){
						// 			plusV=0;
						// 		}else{
						// 			plusV = theMove[forCheak[1]];
						// 		};
						// 		theMove.splice((s * 4 + h),1,(plusV+1));
						// 		forChange.splice((s * 4 + h),1,(plusV+1));
						// 		forCheak[0] = 0;
						// 	}else{
						// 		forCheak[0] = values[s * 4 + h];
						// 		forCheak[1] = s * 4 + h;
						// 	}
						// 	stg.push(values[s * 4 + h])
						// }
						// else{
						// 	var plusV;
						// 	if(!theMove[s * 4 + h]){
						// 		plusV=0;
						// 	}else{
						// 		plusV = theMove[s * 4 + h];
						// 	};
						// 	theMove.splice((s * 4 + h),1,(plusV+1));
					if (values[s * 4 + h] != 0) {
						if(forCheak[0] == values[s * 4 + h]){
								// var plusV;
								// if(!theMove[forCheak[1]]){
								// 	plusV=0;
								// }else{
								// 	plusV = theMove[forCheak[1]];
								// };
								// theMove.splice((s * 4 + h),1,(plusV+plus0));
								toChange.splice((s * 4 + h),1,'moveC'+goTo);
								forChange.push(s * 4 + h);
								forCheak[0]=0;
								plus0++;
							}else{
								forCheak[0] = values[s * 4 + h];
								forCheak[1] = s * 4 + h;
							}
							var plusV;
							if(!theMove[s * 4 + h]){
								plusV=0;
							}else{
								plusV = theMove[s * 4 + h];
							};
							theMove.splice((s * 4 + h),1,(plusV+plus0));
							stg.push(values[s * 4 + h])
						}
						else{
							plus0++;
							console.log(plus0)
						
						}
						s = s + sa;
					}
					for (p = 0; stg[++p];) {
						if (stg[p - 1] == stg[p]) {
							stg[p - 1] += stg[p];
							stg.splice(p, 1);
						}
					}
					for (i = 0, p = (4 - stg.length); i < p; i++) {
						stg.push(0)
					}
					if (goTo == 3) {
						stg = stg.reverse();
					}
					for (i = 0, p = stg.length; i < p; i++) {
						newV[i * 4 + h] = stg[i];
					}
					h = h + ha;
				}
			}

			for (ak in newV) {
				if (newV[ak] != values[ak]) {
					radNew(goTo, newV, 1);
					break;
				}
				if (ak == newV.length - 1) {
					document.querySelector("#box").className += " erroAn";
					setTimeout(function () {
						document.querySelector("#box").className = org;
					}, 500)
				}

			}
			// 位移数据处理总结
			changed.length=0;
			changed.length=16;
			for(ak in forChange){
				var index;
				switch (goTo) {
					case 1:
						index = forChange[ak] - theMove[forChange[ak]]*racNXN;
						changed.splice(index,1,'changeAn1');
						break;
					case 2:
						index = forChange[ak] + theMove[forChange[ak]];
						changed.splice(index,1,'changeAn2');
						break;
					case 3:
						index = forChange[ak] + theMove[forChange[ak]]*racNXN;
						changed.splice(index,1,'changeAn3');
						break;
					case 4:
						index = forChange[ak] - theMove[forChange[ak]];
						changed.splice(index,1,'changeAn4');
						break;
				}
			}
'bronAn'
			// 移动动画添加class
			theMo(goTo,theMove);
			
			setTimeout(() => {
				theMove.length=0;
				changed.length=0;
				toChange.length=0;
				values.length = 0;
				for (ind in newV) {
					values.push(newV[ind])
				}
				// 记录到本地
				setCookie("lastCookie",cookieData(),14);
			}, 100);

			// if（满了）{判定输赢}
			for (ak in values) {
				if (values[ak] == 0) {
					break;
				}
				if (ak == (values.length - 1)) {
					if (cheakLose()) {
						document.querySelector("#box").className += " lose"
						setTimeout(function () {
							document.querySelector("#box").className = org;
						}, 6000)

					}
					function cheakLose() {
						for (i = 0; i < racNXN; i++) {
							for (j = 0; j < racNXN - 1; j++) {
								if (values[i * racNXN + j] == values[i * racNXN + j + 1]) {
									return false;
								}
							}
						}
						for (i = 0; i < racNXN - 1; i++) {
							for (j = 0; j < racNXN; j++) {
								if (values[i * racNXN + j] == values[(i + 1) * racNXN + j]) {
									return false;
								}
							}
						}
						return true;
					}
				}
			}
			console.log(theMove);
			console.log(forChange);

		}
		// 移动动画法则
		function theMo(goTo,arr){
			for(ak in arr){
				if(arr[ak]){
					var arrVal;
					arrVal = arr[ak];
					arr.splice(ak,1,"move"+arrVal+"_"+goTo)
				}
			}
		}

		// 随机生新
		function radNew(goTo, list, nums) {
			newOne.length = 0;
			var raN;
			raN = parseInt(Math.random() * 2 + 1) * 2;
			// 存储棋谱；
			var lastVal = [];
			for (ak in values) {
				lastVal[ak] = values[ak];
			}

			switch (goTo) {
				case 1:
					pick8(0, 2, 2)
					break;
				case 2:
					pick8(0, 0, 0)
					break;
				case 3:
					pick8(0, 0, 2)
					break;
				case 4:
					pick8(2, 0, 0)
					break;

			}
			// 存储棋谱3；
			reBackup.push(lastVal);
			reBa.setAttribute("style", "");
			if (reBackup[3]) {
				reBackup.shift();
			}

			function pick8(hs, ss, ph) {
				var piNum = [];
				if (backUpRe[0]) {
					if (goTo == backUpRe[backUpRe.length - 1].goTo) {
						var last = backUpRe.pop();
						piNum = last.piNum;
						raN = last.raN;
					} else {
						backUpRe.length = 0;
						var pi8 = [];
						var ps;
						ps = 2 - ph;
						for (i = ss; i < ss + 2 + ps; i++) {
							for (j = hs; j < hs + 2 + ph; j++) {
								if (list[i * 4 + j] == 0) {
									pi8.push(i * 4 + j);
								}
							}
						}
						for (i = 0; i < nums; i++) {
							piNum.push(pi8[parseInt(Math.random() * (pi8.length))])
						}
					}
				} else {
					var pi8 = [];
					var ps;
					ps = 2 - ph;
					for (i = ss; i < ss + 2 + ps; i++) {
						for (j = hs; j < hs + 2 + ph; j++) {
							if (list[i * 4 + j] == 0) {
								pi8.push(i * 4 + j);
							}
						}
					}
					for (i = 0; i < nums; i++) {
						piNum.push(pi8[parseInt(Math.random() * (pi8.length))])
					}
				}
				newOne.length = 16;

				for (ak in piNum) {
					list.splice(piNum[ak], 1, raN);
					vGame.newOne.splice(piNum[ak], 1, "bronAn");
					setTimeout(() => {
						vGame.newOne.splice(piNum[ak], 1, "");
					}, 300);
				}

				// 存储棋谱2  {细节操作}
				lastVal.push({
					goTo: goTo,
					raN: raN,
					piNum: piNum
				})
			}

		}
			function cookieData(){
				var val2 = [];
				var valJson = {};
				var val3,val4;
				for(ak in values){
					val2[ak]=values[ak]
				}
				valJson ={'values':val2,'reBackup':reBackup,'backUpRe':backUpRe};
				return  JSON.stringify(valJson);
			}

		reBa.addEventListener("touched", reBackAc, false);
		reBa.addEventListener("click", reBackAc, false);
		function reBackAc() {
			if (reBackup[0]) {
				var backTo;
				backTo = reBackup.pop();
				backUpRe.push(backTo[backTo.length - 1]);
				for (ak in values) {
					values.splice(ak, 1, backTo[ak])
				}
			}
			if (!reBackup[0]) {
				reBa.setAttribute("style", "display:none");
			}
			setCookie("lastCookie",cookieData(),14);
		}
		// js动画
		function animate(obj, css, interval, speedFactor, func) {
			console.log(this)
			clearInterval(obj.timer);
			function getStyle(obj, prop) {
				if (obj.currentStyle)
					return obj.currentStyle[prop]; // ie  
				else
					return document.defaultView.getComputedStyle(obj, null)[prop];  // 非ie  
			}
			obj.timer = setInterval(function () {
				var flag = true;
				for (var prop in css) {
					var cur = 0;
					if (prop == "opacity")
						cur = Math.round(parseFloat(getStyle(obj, prop)) * 100);
					else
						cur = parseInt(getStyle(obj, prop));
					var speed = (css[prop] - cur) * speedFactor;
					speed = speed > 0 ? Math.ceil(speed) : Math.floor(speed);
					if (cur != css[prop])
						flag = false;
					if (prop == "opacity") {
						obj.style.filter = "alpha(opacity : '+(cur + speed)+' )";
						obj.style.opacity = (cur + speed) / 100;
					}
					else
						obj.style[prop] = cur + speed + "px";
				}
				if (flag) {
					clearInterval(obj.timer);
					if (func)
						func();
				}
			}, interval);
		}

	</script>
	<script id="sakura_point_vsh" type="x-shader/x_vertex">
			uniform mat4 uProjection;
			uniform mat4 uModelview;
			uniform vec3 uResolution;
			uniform vec3 uOffset;
			uniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius
			uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start
			
			attribute vec3 aPosition;
			attribute vec3 aEuler;
			attribute vec2 aMisc; //x:size, y:fade
			
			varying vec3 pposition;
			varying float psize;
			varying float palpha;
			varying float pdist;
			
			//varying mat3 rotMat;
			varying vec3 normX;
			varying vec3 normY;
			varying vec3 normZ;
			varying vec3 normal;
			
			varying float diffuse;
			varying float specular;
			varying float rstop;
			varying float distancefade;
			
			void main(void) {
				// Projection is based on vertical angle
				vec4 pos = uModelview * vec4(aPosition + uOffset, 1.0);
				gl_Position = uProjection * pos;
				gl_PointSize = aMisc.x * uProjection[1][1] / -pos.z * uResolution.y * 0.5;
			
				pposition = pos.xyz;
				psize = aMisc.x;
				pdist = length(pos.xyz);
				palpha = smoothstep(0.0, 1.0, (pdist - 0.1) / uFade.z);
			
				vec3 elrsn = sin(aEuler);
				vec3 elrcs = cos(aEuler);
				mat3 rotx = mat3(
					1.0, 0.0, 0.0,
					0.0, elrcs.x, elrsn.x,
					0.0, -elrsn.x, elrcs.x
				);
				mat3 roty = mat3(
					elrcs.y, 0.0, -elrsn.y,
					0.0, 1.0, 0.0,
					elrsn.y, 0.0, elrcs.y
				);
				mat3 rotz = mat3(
					elrcs.z, elrsn.z, 0.0, 
					-elrsn.z, elrcs.z, 0.0,
					0.0, 0.0, 1.0
				);
				mat3 rotmat = rotx * roty * rotz;
				normal = rotmat[2];
			
				mat3 trrotm = mat3(
					rotmat[0][0], rotmat[1][0], rotmat[2][0],
					rotmat[0][1], rotmat[1][1], rotmat[2][1],
					rotmat[0][2], rotmat[1][2], rotmat[2][2]
				);
				normX = trrotm[0];
				normY = trrotm[1];
				normZ = trrotm[2];
			
				const vec3 lit = vec3(0.6917144638660746, 0.6917144638660746, -0.20751433915982237);
			
				float tmpdfs = dot(lit, normal);
				if(tmpdfs < 0.0) {
					normal = -normal;
					tmpdfs = dot(lit, normal);
				}
				diffuse = 0.4 + tmpdfs;
			
				vec3 eyev = normalize(-pos.xyz);
				if(dot(eyev, normal) > 0.0) {
					vec3 hv = normalize(eyev + lit);
					specular = pow(max(dot(hv, normal), 0.0), 20.0);
				}
				else {
					specular = 0.0;
				}
			
				rstop = clamp((abs(pdist - uDOF.x) - uDOF.y) / uDOF.z, 0.0, 1.0);
				rstop = pow(rstop, 0.5);
				//-0.69315 = ln(0.5)
				distancefade = min(1.0, exp((uFade.x - pdist) * 0.69315 / uFade.y));
			}
			</script>
	<script id="sakura_point_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			
			uniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius
			uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start
			
			const vec3 fadeCol = vec3(0.08, 0.03, 0.06);
			
			varying vec3 pposition;
			varying float psize;
			varying float palpha;
			varying float pdist;
			
			//varying mat3 rotMat;
			varying vec3 normX;
			varying vec3 normY;
			varying vec3 normZ;
			varying vec3 normal;
			
			varying float diffuse;
			varying float specular;
			varying float rstop;
			varying float distancefade;
			
			float ellipse(vec2 p, vec2 o, vec2 r) {
				vec2 lp = (p - o) / r;
				return length(lp) - 1.0;
			}
			
			void main(void) {
				vec3 p = vec3(gl_PointCoord - vec2(0.5, 0.5), 0.0) * 2.0;
				vec3 d = vec3(0.0, 0.0, -1.0);
				float nd = normZ.z; //dot(-normZ, d);
				if(abs(nd) < 0.0001) discard;
			
				float np = dot(normZ, p);
				vec3 tp = p + d * np / nd;
				vec2 coord = vec2(dot(normX, tp), dot(normY, tp));
			
				//angle = 15 degree
				const float flwrsn = 0.258819045102521;
				const float flwrcs = 0.965925826289068;
				mat2 flwrm = mat2(flwrcs, -flwrsn, flwrsn, flwrcs);
				vec2 flwrp = vec2(abs(coord.x), coord.y) * flwrm;
			
				float r;
				if(flwrp.x < 0.0) {
					r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.36, 0.96) * 0.5);
				}
				else {
					r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.58, 0.96) * 0.5);
				}
			
				if(r > rstop) discard;
			
				vec3 col = mix(vec3(1.0, 0.8, 0.75), vec3(1.0, 0.9, 0.87), r);
				float grady = mix(0.0, 1.0, pow(coord.y * 0.5 + 0.5, 0.35));
				col *= vec3(1.0, grady, grady);
				col *= mix(0.8, 1.0, pow(abs(coord.x), 0.3));
				col = col * diffuse + specular;
			
				col = mix(fadeCol, col, distancefade);
			
				float alpha = (rstop > 0.001)? (0.5 - r / (rstop * 2.0)) : 1.0;
				alpha = smoothstep(0.0, 1.0, alpha) * palpha;
			
				gl_FragColor = vec4(col * 0.5, alpha);
			}
			</script>
	<!-- effects -->
	<script id="fx_common_vsh" type="x-shader/x_vertex">
			uniform vec3 uResolution;
			attribute vec2 aPosition;
			
			varying vec2 texCoord;
			varying vec2 screenCoord;
			
			void main(void) {
				gl_Position = vec4(aPosition, 0.0, 1.0);
				texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);
				screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
			}
			</script>
	<script id="bg_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			
			uniform vec2 uTimes;
			
			varying vec2 texCoord;
			varying vec2 screenCoord;
			
			void main(void) {
				vec3 col;
				float c;
				vec2 tmpv = texCoord * vec2(0.8, 1.0) - vec2(0.95, 1.0);
				c = exp(-pow(length(tmpv) * 1.8, 2.0));
				col = mix(vec3(0.02, 0.0, 0.03), vec3(0.96, 0.98, 1.0) * 1.5, c);
				gl_FragColor = vec4(col * 0.5, 1.0);
			}
			</script>
	<script id="fx_brightbuf_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			uniform sampler2D uSrc;
			uniform vec2 uDelta;
			
			varying vec2 texCoord;
			varying vec2 screenCoord;
			
			void main(void) {
				vec4 col = texture2D(uSrc, texCoord);
				gl_FragColor = vec4(col.rgb * 2.0 - vec3(0.5), 1.0);
			}
			</script>
	<script id="fx_dirblur_r4_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			uniform sampler2D uSrc;
			uniform vec2 uDelta;
			uniform vec4 uBlurDir; //dir(x, y), stride(z, w)
			
			varying vec2 texCoord;
			varying vec2 screenCoord;
			
			void main(void) {
				vec4 col = texture2D(uSrc, texCoord);
				col = col + texture2D(uSrc, texCoord + uBlurDir.xy * uDelta);
				col = col + texture2D(uSrc, texCoord - uBlurDir.xy * uDelta);
				col = col + texture2D(uSrc, texCoord + (uBlurDir.xy + uBlurDir.zw) * uDelta);
				col = col + texture2D(uSrc, texCoord - (uBlurDir.xy + uBlurDir.zw) * uDelta);
				gl_FragColor = col / 5.0;
			}
			</script>
	<!-- effect fragment shader template -->
	<script id="fx_common_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			uniform sampler2D uSrc;
			uniform vec2 uDelta;
			
			varying vec2 texCoord;
			varying vec2 screenCoord;
			
			void main(void) {
				gl_FragColor = texture2D(uSrc, texCoord);
			}
			</script>
	<!-- post processing -->
	<script id="pp_final_vsh" type="x-shader/x_vertex">
			uniform vec3 uResolution;
			attribute vec2 aPosition;
			varying vec2 texCoord;
			varying vec2 screenCoord;
			void main(void) {
				gl_Position = vec4(aPosition, 0.0, 1.0);
				texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);
				screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
			}
			</script>
	<script id="pp_final_fsh" type="x-shader/x_fragment">
			#ifdef GL_ES
			//precision mediump float;
			precision highp float;
			#endif
			uniform sampler2D uSrc;
			uniform sampler2D uBloom;
			uniform vec2 uDelta;
			varying vec2 texCoord;
			varying vec2 screenCoord;
			void main(void) {
				vec4 srccol = texture2D(uSrc, texCoord) * 2.0;
				vec4 bloomcol = texture2D(uBloom, texCoord);
				vec4 col;
				col = srccol + bloomcol * (vec4(1.0) + srccol);
				col *= smoothstep(1.0, 0.0, pow(length((texCoord - vec2(0.5)) * 2.0), 1.2) * 0.5);
				col = pow(col, vec4(0.45454545454545)); //(1.0 / 2.2)
			
				gl_FragColor = vec4(col.rgb, 1.0);
				gl_FragColor.a = 1.0;
			}
			</script>

	<script>
		// Utilities
		var Vector3 = {};
		var Matrix44 = {};
		Vector3.create = function (x, y, z) {
			return { 'x': x, 'y': y, 'z': z };
		};
		Vector3.dot = function (v0, v1) {
			return v0.x * v1.x + v0.y * v1.y + v0.z * v1.z;
		};
		Vector3.cross = function (v, v0, v1) {
			v.x = v0.y * v1.z - v0.z * v1.y;
			v.y = v0.z * v1.x - v0.x * v1.z;
			v.z = v0.x * v1.y - v0.y * v1.x;
		};
		Vector3.normalize = function (v) {
			var l = v.x * v.x + v.y * v.y + v.z * v.z;
			if (l > 0.00001) {
				l = 1.0 / Math.sqrt(l);
				v.x *= l;
				v.y *= l;
				v.z *= l;
			}
		};
		Vector3.arrayForm = function (v) {
			if (v.array) {
				v.array[0] = v.x;
				v.array[1] = v.y;
				v.array[2] = v.z;
			}
			else {
				v.array = new Float32Array([v.x, v.y, v.z]);
			}
			return v.array;
		};
		Matrix44.createIdentity = function () {
			return new Float32Array([1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0]);
		};
		Matrix44.loadProjection = function (m, aspect, vdeg, near, far) {
			var h = near * Math.tan(vdeg * Math.PI / 180.0 * 0.5) * 2.0;
			var w = h * aspect;

			m[0] = 2.0 * near / w;
			m[1] = 0.0;
			m[2] = 0.0;
			m[3] = 0.0;

			m[4] = 0.0;
			m[5] = 2.0 * near / h;
			m[6] = 0.0;
			m[7] = 0.0;

			m[8] = 0.0;
			m[9] = 0.0;
			m[10] = -(far + near) / (far - near);
			m[11] = -1.0;

			m[12] = 0.0;
			m[13] = 0.0;
			m[14] = -2.0 * far * near / (far - near);
			m[15] = 0.0;
		};
		Matrix44.loadLookAt = function (m, vpos, vlook, vup) {
			var frontv = Vector3.create(vpos.x - vlook.x, vpos.y - vlook.y, vpos.z - vlook.z);
			Vector3.normalize(frontv);
			var sidev = Vector3.create(1.0, 0.0, 0.0);
			Vector3.cross(sidev, vup, frontv);
			Vector3.normalize(sidev);
			var topv = Vector3.create(1.0, 0.0, 0.0);
			Vector3.cross(topv, frontv, sidev);
			Vector3.normalize(topv);

			m[0] = sidev.x;
			m[1] = topv.x;
			m[2] = frontv.x;
			m[3] = 0.0;

			m[4] = sidev.y;
			m[5] = topv.y;
			m[6] = frontv.y;
			m[7] = 0.0;

			m[8] = sidev.z;
			m[9] = topv.z;
			m[10] = frontv.z;
			m[11] = 0.0;

			m[12] = -(vpos.x * m[0] + vpos.y * m[4] + vpos.z * m[8]);
			m[13] = -(vpos.x * m[1] + vpos.y * m[5] + vpos.z * m[9]);
			m[14] = -(vpos.x * m[2] + vpos.y * m[6] + vpos.z * m[10]);
			m[15] = 1.0;
		};

		//
		var timeInfo = {
			'start': 0, 'prev': 0, // Date
			'delta': 0, 'elapsed': 0 // Number(sec)
		};

		//
		var gl;
		var renderSpec = {
			'width': 0,
			'height': 0,
			'aspect': 1,
			'array': new Float32Array(3),
			'halfWidth': 0,
			'halfHeight': 0,
			'halfArray': new Float32Array(3)
			// and some render targets. see setViewport()
		};
		renderSpec.setSize = function (w, h) {
			renderSpec.width = w;
			renderSpec.height = h;
			renderSpec.aspect = renderSpec.width / renderSpec.height;
			renderSpec.array[0] = renderSpec.width;
			renderSpec.array[1] = renderSpec.height;
			renderSpec.array[2] = renderSpec.aspect;

			renderSpec.halfWidth = Math.floor(w / 2);
			renderSpec.halfHeight = Math.floor(h / 2);
			renderSpec.halfArray[0] = renderSpec.halfWidth;
			renderSpec.halfArray[1] = renderSpec.halfHeight;
			renderSpec.halfArray[2] = renderSpec.halfWidth / renderSpec.halfHeight;
		};

		function deleteRenderTarget(rt) {
			gl.deleteFramebuffer(rt.frameBuffer);
			gl.deleteRenderbuffer(rt.renderBuffer);
			gl.deleteTexture(rt.texture);
		}

		function createRenderTarget(w, h) {
			var ret = {
				'width': w,
				'height': h,
				'sizeArray': new Float32Array([w, h, w / h]),
				'dtxArray': new Float32Array([1.0 / w, 1.0 / h])
			};
			ret.frameBuffer = gl.createFramebuffer();
			ret.renderBuffer = gl.createRenderbuffer();
			ret.texture = gl.createTexture();

			gl.bindTexture(gl.TEXTURE_2D, ret.texture);
			gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, w, h, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);

			gl.bindFramebuffer(gl.FRAMEBUFFER, ret.frameBuffer);
			gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, ret.texture, 0);

			gl.bindRenderbuffer(gl.RENDERBUFFER, ret.renderBuffer);
			gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, w, h);
			gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, ret.renderBuffer);

			gl.bindTexture(gl.TEXTURE_2D, null);
			gl.bindRenderbuffer(gl.RENDERBUFFER, null);
			gl.bindFramebuffer(gl.FRAMEBUFFER, null);

			return ret;
		}

		function compileShader(shtype, shsrc) {
			var retsh = gl.createShader(shtype);

			gl.shaderSource(retsh, shsrc);
			gl.compileShader(retsh);

			if (!gl.getShaderParameter(retsh, gl.COMPILE_STATUS)) {
				var errlog = gl.getShaderInfoLog(retsh);
				gl.deleteShader(retsh);
				console.error(errlog);
				return null;
			}
			return retsh;
		}

		function createShader(vtxsrc, frgsrc, uniformlist, attrlist) {
			var vsh = compileShader(gl.VERTEX_SHADER, vtxsrc);
			var fsh = compileShader(gl.FRAGMENT_SHADER, frgsrc);

			if (vsh == null || fsh == null) {
				return null;
			}

			var prog = gl.createProgram();
			gl.attachShader(prog, vsh);
			gl.attachShader(prog, fsh);

			gl.deleteShader(vsh);
			gl.deleteShader(fsh);

			gl.linkProgram(prog);
			if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) {
				var errlog = gl.getProgramInfoLog(prog);
				console.error(errlog);
				return null;
			}

			if (uniformlist) {
				prog.uniforms = {};
				for (var i = 0; i < uniformlist.length; i++) {
					prog.uniforms[uniformlist[i]] = gl.getUniformLocation(prog, uniformlist[i]);
				}
			}

			if (attrlist) {
				prog.attributes = {};
				for (var i = 0; i < attrlist.length; i++) {
					var attr = attrlist[i];
					prog.attributes[attr] = gl.getAttribLocation(prog, attr);
				}
			}

			return prog;
		}

		function useShader(prog) {
			gl.useProgram(prog);
			for (var attr in prog.attributes) {
				gl.enableVertexAttribArray(prog.attributes[attr]);;
			}
		}

		function unuseShader(prog) {
			for (var attr in prog.attributes) {
				gl.disableVertexAttribArray(prog.attributes[attr]);;
			}
			gl.useProgram(null);
		}

		/////
		var projection = {
			'angle': 60,
			'nearfar': new Float32Array([0.1, 100.0]),
			'matrix': Matrix44.createIdentity()
		};
		var camera = {
			'position': Vector3.create(0, 0, 100),
			'lookat': Vector3.create(0, 0, 0),
			'up': Vector3.create(0, 1, 0),
			'dof': Vector3.create(10.0, 4.0, 8.0),
			'matrix': Matrix44.createIdentity()
		};

		var pointFlower = {};
		var meshFlower = {};
		var sceneStandBy = false;

		var BlossomParticle = function () {
			this.velocity = new Array(3);
			this.rotation = new Array(3);
			this.position = new Array(3);
			this.euler = new Array(3);
			this.size = 1.0;
			this.alpha = 1.0;
			this.zkey = 0.0;
		};

		BlossomParticle.prototype.setVelocity = function (vx, vy, vz) {
			this.velocity[0] = vx;
			this.velocity[1] = vy;
			this.velocity[2] = vz;
		};

		BlossomParticle.prototype.setRotation = function (rx, ry, rz) {
			this.rotation[0] = rx;
			this.rotation[1] = ry;
			this.rotation[2] = rz;
		};

		BlossomParticle.prototype.setPosition = function (nx, ny, nz) {
			this.position[0] = nx;
			this.position[1] = ny;
			this.position[2] = nz;
		};

		BlossomParticle.prototype.setEulerAngles = function (rx, ry, rz) {
			this.euler[0] = rx;
			this.euler[1] = ry;
			this.euler[2] = rz;
		};

		BlossomParticle.prototype.setSize = function (s) {
			this.size = s;
		};

		BlossomParticle.prototype.update = function (dt, et) {
			this.position[0] += this.velocity[0] * dt;
			this.position[1] += this.velocity[1] * dt;
			this.position[2] += this.velocity[2] * dt;

			this.euler[0] += this.rotation[0] * dt;
			this.euler[1] += this.rotation[1] * dt;
			this.euler[2] += this.rotation[2] * dt;
		};

		function createPointFlowers() {
			// get point sizes
			var prm = gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE);
			renderSpec.pointSize = { 'min': prm[0], 'max': prm[1] };

			var vtxsrc = document.getElementById("sakura_point_vsh").textContent;
			var frgsrc = document.getElementById("sakura_point_fsh").textContent;

			pointFlower.program = createShader(
				vtxsrc, frgsrc,
				['uProjection', 'uModelview', 'uResolution', 'uOffset', 'uDOF', 'uFade'],
				['aPosition', 'aEuler', 'aMisc']
			);

			useShader(pointFlower.program);
			pointFlower.offset = new Float32Array([0.0, 0.0, 0.0]);
			pointFlower.fader = Vector3.create(0.0, 10.0, 0.0);

			// paramerters: velocity[3], rotate[3]
			pointFlower.numFlowers = 1600;
			pointFlower.particles = new Array(pointFlower.numFlowers);
			// vertex attributes {position[3], euler_xyz[3], size[1]}
			pointFlower.dataArray = new Float32Array(pointFlower.numFlowers * (3 + 3 + 2));
			pointFlower.positionArrayOffset = 0;
			pointFlower.eulerArrayOffset = pointFlower.numFlowers * 3;
			pointFlower.miscArrayOffset = pointFlower.numFlowers * 6;

			pointFlower.buffer = gl.createBuffer();
			gl.bindBuffer(gl.ARRAY_BUFFER, pointFlower.buffer);
			gl.bufferData(gl.ARRAY_BUFFER, pointFlower.dataArray, gl.DYNAMIC_DRAW);
			gl.bindBuffer(gl.ARRAY_BUFFER, null);

			unuseShader(pointFlower.program);

			for (var i = 0; i < pointFlower.numFlowers; i++) {
				pointFlower.particles[i] = new BlossomParticle();
			}
		}

		function initPointFlowers() {
			//area
			pointFlower.area = Vector3.create(20.0, 20.0, 20.0);
			pointFlower.area.x = pointFlower.area.y * renderSpec.aspect;

			pointFlower.fader.x = 10.0; //env fade start
			pointFlower.fader.y = pointFlower.area.z; //env fade half
			pointFlower.fader.z = 0.1;  //near fade start

			//particles
			var PI2 = Math.PI * 2.0;
			var tmpv3 = Vector3.create(0, 0, 0);
			var tmpv = 0;
			var symmetryrand = function () { return (Math.random() * 2.0 - 1.0); };
			for (var i = 0; i < pointFlower.numFlowers; i++) {
				var tmpprtcl = pointFlower.particles[i];

				//velocity
				tmpv3.x = symmetryrand() * 0.3 + 0.8;
				tmpv3.y = symmetryrand() * 0.2 - 1.0;
				tmpv3.z = symmetryrand() * 0.3 + 0.5;
				Vector3.normalize(tmpv3);
				tmpv = 2.0 + Math.random() * 1.0;
				tmpprtcl.setVelocity(tmpv3.x * tmpv, tmpv3.y * tmpv, tmpv3.z * tmpv);

				//rotation
				tmpprtcl.setRotation(
					symmetryrand() * PI2 * 0.5,
					symmetryrand() * PI2 * 0.5,
					symmetryrand() * PI2 * 0.5
				);

				//position
				tmpprtcl.setPosition(
					symmetryrand() * pointFlower.area.x,
					symmetryrand() * pointFlower.area.y,
					symmetryrand() * pointFlower.area.z
				);

				//euler
				tmpprtcl.setEulerAngles(
					Math.random() * Math.PI * 2.0,
					Math.random() * Math.PI * 2.0,
					Math.random() * Math.PI * 2.0
				);

				//size
				tmpprtcl.setSize(0.9 + Math.random() * 0.1);
			}
		}

		function renderPointFlowers() {
			//update
			var PI2 = Math.PI * 2.0;
			var limit = [pointFlower.area.x, pointFlower.area.y, pointFlower.area.z];
			var repeatPos = function (prt, cmp, limit) {
				if (Math.abs(prt.position[cmp]) - prt.size * 0.5 > limit) {
					//out of area
					if (prt.position[cmp] > 0) {
						prt.position[cmp] -= limit * 2.0;
					}
					else {
						prt.position[cmp] += limit * 2.0;
					}
				}
			};
			var repeatEuler = function (prt, cmp) {
				prt.euler[cmp] = prt.euler[cmp] % PI2;
				if (prt.euler[cmp] < 0.0) {
					prt.euler[cmp] += PI2;
				}
			};

			for (var i = 0; i < pointFlower.numFlowers; i++) {
				var prtcl = pointFlower.particles[i];
				prtcl.update(timeInfo.delta, timeInfo.elapsed);
				repeatPos(prtcl, 0, pointFlower.area.x);
				repeatPos(prtcl, 1, pointFlower.area.y);
				repeatPos(prtcl, 2, pointFlower.area.z);
				repeatEuler(prtcl, 0);
				repeatEuler(prtcl, 1);
				repeatEuler(prtcl, 2);

				prtcl.alpha = 1.0;//(pointFlower.area.z - prtcl.position[2]) * 0.5;

				prtcl.zkey = (camera.matrix[2] * prtcl.position[0]
					+ camera.matrix[6] * prtcl.position[1]
					+ camera.matrix[10] * prtcl.position[2]
					+ camera.matrix[14]);
			}

			// sort
			pointFlower.particles.sort(function (p0, p1) { return p0.zkey - p1.zkey; });

			// update data
			var ipos = pointFlower.positionArrayOffset;
			var ieuler = pointFlower.eulerArrayOffset;
			var imisc = pointFlower.miscArrayOffset;
			for (var i = 0; i < pointFlower.numFlowers; i++) {
				var prtcl = pointFlower.particles[i];
				pointFlower.dataArray[ipos] = prtcl.position[0];
				pointFlower.dataArray[ipos + 1] = prtcl.position[1];
				pointFlower.dataArray[ipos + 2] = prtcl.position[2];
				ipos += 3;
				pointFlower.dataArray[ieuler] = prtcl.euler[0];
				pointFlower.dataArray[ieuler + 1] = prtcl.euler[1];
				pointFlower.dataArray[ieuler + 2] = prtcl.euler[2];
				ieuler += 3;
				pointFlower.dataArray[imisc] = prtcl.size;
				pointFlower.dataArray[imisc + 1] = prtcl.alpha;
				imisc += 2;
			}

			//draw
			gl.enable(gl.BLEND);
			//gl.disable(gl.DEPTH_TEST);
			gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

			var prog = pointFlower.program;
			useShader(prog);

			gl.uniformMatrix4fv(prog.uniforms.uProjection, false, projection.matrix);
			gl.uniformMatrix4fv(prog.uniforms.uModelview, false, camera.matrix);
			gl.uniform3fv(prog.uniforms.uResolution, renderSpec.array);
			gl.uniform3fv(prog.uniforms.uDOF, Vector3.arrayForm(camera.dof));
			gl.uniform3fv(prog.uniforms.uFade, Vector3.arrayForm(pointFlower.fader));

			gl.bindBuffer(gl.ARRAY_BUFFER, pointFlower.buffer);
			gl.bufferData(gl.ARRAY_BUFFER, pointFlower.dataArray, gl.DYNAMIC_DRAW);

			gl.vertexAttribPointer(prog.attributes.aPosition, 3, gl.FLOAT, false, 0, pointFlower.positionArrayOffset * Float32Array.BYTES_PER_ELEMENT);
			gl.vertexAttribPointer(prog.attributes.aEuler, 3, gl.FLOAT, false, 0, pointFlower.eulerArrayOffset * Float32Array.BYTES_PER_ELEMENT);
			gl.vertexAttribPointer(prog.attributes.aMisc, 2, gl.FLOAT, false, 0, pointFlower.miscArrayOffset * Float32Array.BYTES_PER_ELEMENT);

			// doubler
			for (var i = 1; i < 2; i++) {
				var zpos = i * -2.0;
				pointFlower.offset[0] = pointFlower.area.x * -1.0;
				pointFlower.offset[1] = pointFlower.area.y * -1.0;
				pointFlower.offset[2] = pointFlower.area.z * zpos;
				gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);
				gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);

				pointFlower.offset[0] = pointFlower.area.x * -1.0;
				pointFlower.offset[1] = pointFlower.area.y * 1.0;
				pointFlower.offset[2] = pointFlower.area.z * zpos;
				gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);
				gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);

				pointFlower.offset[0] = pointFlower.area.x * 1.0;
				pointFlower.offset[1] = pointFlower.area.y * -1.0;
				pointFlower.offset[2] = pointFlower.area.z * zpos;
				gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);
				gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);

				pointFlower.offset[0] = pointFlower.area.x * 1.0;
				pointFlower.offset[1] = pointFlower.area.y * 1.0;
				pointFlower.offset[2] = pointFlower.area.z * zpos;
				gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);
				gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);
			}

			//main
			pointFlower.offset[0] = 0.0;
			pointFlower.offset[1] = 0.0;
			pointFlower.offset[2] = 0.0;
			gl.uniform3fv(prog.uniforms.uOffset, pointFlower.offset);
			gl.drawArrays(gl.POINT, 0, pointFlower.numFlowers);

			gl.bindBuffer(gl.ARRAY_BUFFER, null);
			unuseShader(prog);

			gl.enable(gl.DEPTH_TEST);
			gl.disable(gl.BLEND);
		}

		// effects
		//common util
		function createEffectProgram(vtxsrc, frgsrc, exunifs, exattrs) {
			var ret = {};
			var unifs = ['uResolution', 'uSrc', 'uDelta'];
			if (exunifs) {
				unifs = unifs.concat(exunifs);
			}
			var attrs = ['aPosition'];
			if (exattrs) {
				attrs = attrs.concat(exattrs);
			}

			ret.program = createShader(vtxsrc, frgsrc, unifs, attrs);
			useShader(ret.program);

			ret.dataArray = new Float32Array([
				-1.0, -1.0,
				1.0, -1.0,
				-1.0, 1.0,
				1.0, 1.0
			]);
			ret.buffer = gl.createBuffer();
			gl.bindBuffer(gl.ARRAY_BUFFER, ret.buffer);
			gl.bufferData(gl.ARRAY_BUFFER, ret.dataArray, gl.STATIC_DRAW);

			gl.bindBuffer(gl.ARRAY_BUFFER, null);
			unuseShader(ret.program);

			return ret;
		}

		// basic usage
		// useEffect(prog, srctex({'texture':texid, 'dtxArray':(f32)[dtx, dty]})); //basic initialize
		// gl.uniform**(...); //additional uniforms
		// drawEffect()
		// unuseEffect(prog)
		// TEXTURE0 makes src
		function useEffect(fxobj, srctex) {
			var prog = fxobj.program;
			useShader(prog);
			gl.uniform3fv(prog.uniforms.uResolution, renderSpec.array);

			if (srctex != null) {
				gl.uniform2fv(prog.uniforms.uDelta, srctex.dtxArray);
				gl.uniform1i(prog.uniforms.uSrc, 0);

				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, srctex.texture);
			}
		}
		function drawEffect(fxobj) {
			gl.bindBuffer(gl.ARRAY_BUFFER, fxobj.buffer);
			gl.vertexAttribPointer(fxobj.program.attributes.aPosition, 2, gl.FLOAT, false, 0, 0);
			gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
		}
		function unuseEffect(fxobj) {
			unuseShader(fxobj.program);
		}

		var effectLib = {};
		function createEffectLib() {

			var vtxsrc, frgsrc;
			//common
			var cmnvtxsrc = document.getElementById("fx_common_vsh").textContent;

			//background
			frgsrc = document.getElementById("bg_fsh").textContent;
			effectLib.sceneBg = createEffectProgram(cmnvtxsrc, frgsrc, ['uTimes'], null);

			// make brightpixels buffer
			frgsrc = document.getElementById("fx_brightbuf_fsh").textContent;
			effectLib.mkBrightBuf = createEffectProgram(cmnvtxsrc, frgsrc, null, null);

			// direction blur
			frgsrc = document.getElementById("fx_dirblur_r4_fsh").textContent;
			effectLib.dirBlur = createEffectProgram(cmnvtxsrc, frgsrc, ['uBlurDir'], null);

			//final composite
			vtxsrc = document.getElementById("pp_final_vsh").textContent;
			frgsrc = document.getElementById("pp_final_fsh").textContent;
			effectLib.finalComp = createEffectProgram(vtxsrc, frgsrc, ['uBloom'], null);
		}

		// background
		function createBackground() {
			//console.log("create background");
		}
		function initBackground() {
			//console.log("init background");
		}
		function renderBackground() {
			gl.disable(gl.DEPTH_TEST);

			useEffect(effectLib.sceneBg, null);
			gl.uniform2f(effectLib.sceneBg.program.uniforms.uTimes, timeInfo.elapsed, timeInfo.delta);
			drawEffect(effectLib.sceneBg);
			unuseEffect(effectLib.sceneBg);

			gl.enable(gl.DEPTH_TEST);
		}

		// post process
		var postProcess = {};
		function createPostProcess() {
			//console.log("create post process");
		}
		function initPostProcess() {
			//console.log("init post process");
		}

		function renderPostProcess() {
			gl.enable(gl.TEXTURE_2D);
			gl.disable(gl.DEPTH_TEST);
			var bindRT = function (rt, isclear) {
				gl.bindFramebuffer(gl.FRAMEBUFFER, rt.frameBuffer);
				gl.viewport(0, 0, rt.width, rt.height);
				if (isclear) {
					gl.clearColor(0, 0, 0, 0);
					gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
				}
			};

			//make bright buff
			bindRT(renderSpec.wHalfRT0, true);
			useEffect(effectLib.mkBrightBuf, renderSpec.mainRT);
			drawEffect(effectLib.mkBrightBuf);
			unuseEffect(effectLib.mkBrightBuf);

			// make bloom
			for (var i = 0; i < 2; i++) {
				var p = 1.5 + 1 * i;
				var s = 2.0 + 1 * i;
				bindRT(renderSpec.wHalfRT1, true);
				useEffect(effectLib.dirBlur, renderSpec.wHalfRT0);
				gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir, p, 0.0, s, 0.0);
				drawEffect(effectLib.dirBlur);
				unuseEffect(effectLib.dirBlur);

				bindRT(renderSpec.wHalfRT0, true);
				useEffect(effectLib.dirBlur, renderSpec.wHalfRT1);
				gl.uniform4f(effectLib.dirBlur.program.uniforms.uBlurDir, 0.0, p, 0.0, s);
				drawEffect(effectLib.dirBlur);
				unuseEffect(effectLib.dirBlur);
			}

			//display
			gl.bindFramebuffer(gl.FRAMEBUFFER, null);
			gl.viewport(0, 0, renderSpec.width, renderSpec.height);
			gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

			useEffect(effectLib.finalComp, renderSpec.mainRT);
			gl.uniform1i(effectLib.finalComp.program.uniforms.uBloom, 1);
			gl.activeTexture(gl.TEXTURE1);
			gl.bindTexture(gl.TEXTURE_2D, renderSpec.wHalfRT0.texture);
			drawEffect(effectLib.finalComp);
			unuseEffect(effectLib.finalComp);

			gl.enable(gl.DEPTH_TEST);
		}

		/////
		var SceneEnv = {};
		function createScene() {
			createEffectLib();
			createBackground();
			createPointFlowers();
			createPostProcess();
			sceneStandBy = true;
		}

		function initScene() {
			initBackground();
			initPointFlowers();
			initPostProcess();

			//camera.position.z = 17.320508;
			camera.position.z = pointFlower.area.z + projection.nearfar[0];
			projection.angle = Math.atan2(pointFlower.area.y, camera.position.z + pointFlower.area.z) * 180.0 / Math.PI * 2.0;
			Matrix44.loadProjection(projection.matrix, renderSpec.aspect, projection.angle, projection.nearfar[0], projection.nearfar[1]);
		}

		function renderScene() {
			//draw
			Matrix44.loadLookAt(camera.matrix, camera.position, camera.lookat, camera.up);

			gl.enable(gl.DEPTH_TEST);

			//gl.bindFramebuffer(gl.FRAMEBUFFER, null);
			gl.bindFramebuffer(gl.FRAMEBUFFER, renderSpec.mainRT.frameBuffer);
			gl.viewport(0, 0, renderSpec.mainRT.width, renderSpec.mainRT.height);
			gl.clearColor(0.005, 0, 0.05, 0);
			gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

			renderBackground();
			renderPointFlowers();
			renderPostProcess();
		}

		/////
		function onResize(e) {
			makeCanvasFullScreen(document.getElementById("sakura"));
			setViewports();
			if (sceneStandBy) {
				initScene();
			}
		}

		function setViewports() {
			renderSpec.setSize(gl.canvas.width, gl.canvas.height);

			gl.clearColor(0.2, 0.2, 0.5, 1.0);
			gl.viewport(0, 0, renderSpec.width, renderSpec.height);

			var rtfunc = function (rtname, rtw, rth) {
				var rt = renderSpec[rtname];
				if (rt) deleteRenderTarget(rt);
				renderSpec[rtname] = createRenderTarget(rtw, rth);
			};
			rtfunc('mainRT', renderSpec.width, renderSpec.height);
			rtfunc('wFullRT0', renderSpec.width, renderSpec.height);
			rtfunc('wFullRT1', renderSpec.width, renderSpec.height);
			rtfunc('wHalfRT0', renderSpec.halfWidth, renderSpec.halfHeight);
			rtfunc('wHalfRT1', renderSpec.halfWidth, renderSpec.halfHeight);
		}

		function render() {
			renderScene();
		}

		var animating = true;
		function toggleAnimation(elm) {
			animating ^= true;
			if (animating) animate();
			if (elm) {
				elm.innerHTML = animating ? "Stop" : "Start";
			}
		}

		function stepAnimation() {
			if (!animating) animate();
		}

		function animate() {
			var curdate = new Date();
			timeInfo.elapsed = (curdate - timeInfo.start) / 1000.0;
			timeInfo.delta = (curdate - timeInfo.prev) / 1000.0;
			timeInfo.prev = curdate;

			if (animating) requestAnimationFrame(animate);
			render();
		}

		function makeCanvasFullScreen(canvas) {
			var b = document.body;
			var d = document.documentElement;
			fullw = Math.max(b.clientWidth, b.scrollWidth, d.scrollWidth, d.clientWidth);
			fullh = Math.max(b.clientHeight, b.scrollHeight, d.scrollHeight, d.clientHeight);
			canvas.width = fullw;
			canvas.height = fullh;
		}

		window.addEventListener('load', function (e) {
			var canvas = document.getElementById("sakura");
			try {
				makeCanvasFullScreen(canvas);
				gl = canvas.getContext('experimental-webgl');
			} catch (e) {
				alert("WebGL not supported." + e);
				console.error(e);
				return;
			}

			window.addEventListener('resize', onResize);

			setViewports();
			createScene();
			initScene();

			timeInfo.start = new Date();
			timeInfo.prev = timeInfo.start;
			animate();
		});

		//set window.requestAnimationFrame
		(function (w, r) {
			w['r' + r] = w['r' + r] || w['webkitR' + r] || w['mozR' + r] || w['msR' + r] || w['oR' + r] || function (c) { w.setTimeout(c, 1000 / 60); };
		})(window, 'equestAnimationFrame');
	</script>
</body>

</html>